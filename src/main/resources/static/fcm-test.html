<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FCM 테스트 페이지</title>
    <!-- Tailwind CSS와 Font Awesome을 사용해 디자인을 개선합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

<div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-md text-center">
    <div class="text-indigo-600 text-4xl mb-4">
        <i class="fa-solid fa-bell"></i>
    </div>
    <h2 class="text-2xl font-bold mb-6 text-gray-800">FCM 푸시 알림 테스트</h2>
    <p class="text-sm text-gray-600 mb-4">
        아래 버튼을 누르면 푸시 알림 권한을 요청하고, 토큰을 발급받아 서버에 전송합니다.
    </p>

    <button
            onclick="registerAndSendToken()"
            class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-full hover:bg-indigo-700 transition-colors duration-300 shadow-md transform hover:scale-105"
    >
        <i class="fa-solid fa-arrow-up-right-from-square mr-2"></i>토큰 발급 + 서버 전송
    </button>

    <div id="result" class="mt-6 text-sm text-gray-700 p-4 bg-gray-50 rounded-lg border border-gray-200 text-left overflow-x-auto">
        상태: 대기 중...
    </div>
</div>

<!-- ✅ Firebase SDKs (v10.7.0) -->
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-messaging-compat.js"></script>

<script>
    // 1. Firebase 설정 (Firebase 콘솔에서 복사한 값 입력)
    const firebaseConfig = {
        apiKey: "AIzaSyBJ9T7mt7CtwZm1E89qLK-1XeRitcwV-Es",
        authDomain: "fcmtest-bd402.firebaseapp.com",
        projectId: "fcmtest-bd402",
        storageBucket: "fcmtest-bd402.firebasestorage.app",
        messagingSenderId: "603915203012",
        appId: "1:603915203012:web:fb00e2ef0dab3fb51ef491"
    };
    const VAPID_KEY = "BGhAum-SJ8ZrzB6LU5Y2-eBEwzgqK599sBKt60_6w0Aw8cKWTEQRZQ8slpUX4vJJ-wsXRyIvM5znTDaUncqxm5o";

    // 2. Firebase 초기화
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();
    const resultElement = document.getElementById("result");

    // 3. 토큰 발급 및 서버 전송 함수
    async function registerAndSendToken() {
        try {
            resultElement.textContent = "상태: 토큰 발급 및 서버 전송 중...";

            // 서비스 워커 등록
            const registration = await navigator.serviceWorker.register("firebase-messaging-sw.js");

            // 알림 권한 요청
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                throw new Error("알림 권한이 거부되었습니다.");
            }

            // FCM 토큰 발급
            const currentToken = await messaging.getToken({
                vapidKey: VAPID_KEY,
                serviceWorkerRegistration: registration
            });

            if (currentToken) {
                console.log("✅ 발급된 FCM 토큰:", currentToken);
                resultElement.textContent = "✅ 토큰 발급 성공: " + currentToken;

                // 4. 서버로 토큰 전송 (여기서 HTTP 요청이 이뤄집니다)
                // Postman에서 테스트했던 것처럼 userId와 token을 JSON 형식으로 보냅니다.
                const res = await fetch("http://localhost:10000/api/users/fcm-token", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-User-Id": "1" // ✅ 테스트를 위한 유저 ID (실제로는 로그인 후 동적으로 설정)
                    },
                    body: JSON.stringify({ token: currentToken })
                });

                if (res.ok) {
                    const msg = await res.text();
                    console.log("📤 서버 응답:", msg);
                    resultElement.textContent += "\n📤 서버 응답: " + msg;
                } else {
                    const errorText = await res.text();
                    console.error("❌ 서버 전송 실패:", res.status, errorText);
                    resultElement.textContent += "\n❌ 서버 전송 실패: " + res.status;
                }

            } else {
                resultElement.textContent = "❌ 토큰 발급 실패: 권한 거부됨";
            }
        } catch (err) {
            console.error("❌ FCM 오류:", err);
            resultElement.textContent = "⚠️ 오류: " + err.message;
        }
    }

    // 5. 포그라운드 알림 수신 처리 (앱/웹페이지가 열려 있을 때)
    messaging.onMessage((payload) => {
        console.log("💬 포그라운드 메시지 수신:", payload);
        alert(`🔔 ${payload.notification?.title}\n${payload.notification?.body}`);
    });
</script>
</body>
</html>