<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>FCM í…ŒìŠ¤íŠ¸</title>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
</head>
<body>
<h2>ğŸ”” FCM í‘¸ì‹œ í…ŒìŠ¤íŠ¸</h2>
<button onclick="registerAndSendToken()">ğŸ“¤ í† í° ë°œê¸‰ + ì„œë²„ ì „ì†¡</button>
<pre id="result"></pre>

<script>
    // 1. Firebase ì„¤ì • (ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ ê°’ ì…ë ¥)
    const firebaseConfig = {
      apiKey: "AIzaSyBJ9T7mt7CtwZm1E89qLK-1XeRitcwV-Es",
      authDomain: "fcmtest-bd402.firebaseapp.com",
      projectId: "fcmtest-bd402",
      storageBucket: "fcmtest-bd402.firebasestorage.app",
      messagingSenderId: "603915203012",
      appId: "1:603915203012:web:fb00e2ef0dab3fb51ef491"
    };

    const VAPID_KEY = "BGhAum-SJ8ZrzB6LU5Y2-eBEwzgqK599sBKt60_6w0Aw8cKWTEQRZQ8slpUX4vJJ-wsXRyIvM5znTDaUncqxm5o"; // Web Push ì¸ì¦ í‚¤

    // 2. Firebase ì´ˆê¸°í™”
    firebase.initializeApp(firebaseConfig);
    const messaging = firebase.messaging();

    // 3. í† í° ë°œê¸‰ + ì„œë²„ ì „ì†¡
    async function registerAndSendToken() {
      try {
        const registration = await navigator.serviceWorker.register("firebase-messaging-sw.js");
        const currentToken = await messaging.getToken({
          vapidKey: VAPID_KEY,
          serviceWorkerRegistration: registration
        });

        if (currentToken) {
          console.log("âœ… FCM í† í°:", currentToken);
          document.getElementById("result").textContent = "âœ… í† í°: " + currentToken;

          // ì„œë²„ë¡œ í† í° ì „ì†¡
          const res = await fetch("http://localhost:8080/fcm/token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ userId: 1, token: currentToken })
          });
          const msg = await res.text();
          console.log("ğŸ“¤ ì„œë²„ ì‘ë‹µ:", msg);
        } else {
          document.getElementById("result").textContent = "âŒ í† í° ë°œê¸‰ ì‹¤íŒ¨: ê¶Œí•œ ê±°ë¶€ë¨";
        }
      } catch (err) {
        console.error("âŒ FCM ì˜¤ë¥˜:", err);
        document.getElementById("result").textContent = "âš ï¸ ì˜¤ë¥˜: " + err.message;
      }
    }

    // 4. í¬ê·¸ë¼ìš´ë“œ ì•Œë¦¼ ìˆ˜ì‹  ì²˜ë¦¬
    messaging.onMessage((payload) => {
      console.log("ğŸ’¬ í¬ê·¸ë¼ìš´ë“œ ë©”ì‹œì§€ ìˆ˜ì‹ :", payload);
      alert(`ğŸ”” ${payload.notification?.title}\n${payload.notification?.body}`);
    });
</script>
</body>
</html>
